# Structure Sampling Scripts

This directory contains tools for sampling, selecting, and generating atomic structures for NEP training and molecular dynamics simulations.

## Overview

Structure sampling is crucial for creating diverse and representative training sets. These scripts provide:
- **Uniform and random sampling**: Basic statistical sampling methods
- **FPS (Farthest Point Sampling)**: Maximizing structural diversity using PyNEP or NEPtrain
- **Structure perturbation**: Generating variations for training set augmentation
- **Active learning selection**: Identifying structures with maximum force deviations
- **Frame extraction**: Selecting specific structures from trajectories

All scripts can be accessed through `gpumdkit.sh` interactive mode or run directly.

---

## Quick Command Reference

| Task | Command/Method |
|------|----------------|
| Uniform sampling | `python sample_structures.py <xyz> uniform <n>` |
| Random sampling | `python sample_structures.py <xyz> random <n>` |
| PyNEP FPS | `gpumdkit.sh -pynep <sample> <train> <model>` |
| NEPtrain FPS | Via interactive mode option 203 |
| Perturb structure | Via interactive mode option 204 |
| Max force deviation | Via interactive mode option 205 |

---

## Scripts

### sample_structures.py

Basic structure sampling using uniform or random methods.

---

This function calls the `perturb_structure.py` script to generate the perturbed structures.

`<input.vasp>`: `filename.vasp`

`<pert_num>`: number of perturbed structures

`<cell_pert_fraction>`: A fraction determines how much (relatively) will cell deform

`<atom_pert_distance>`: A distance determines how far atoms will move (in angstrom).

`<atom_pert_style>`: `<uniform>`, `<normal>`, `<const>`

#### Usage

```sh
python perturb_structure.py <input.vasp> <pert_num> <cell_pert_fraction> <atom_pert_distance> <atom_pert_style>
```

#### Example

```sh
python perturb_structure.py FAPbI3.vasp 20 0.03 0.2 normal
```

This command will generate 20 perturbed structures.

### pynep_select_structs.py

---

This script samples structures by using the farthest point sampling method implemented in the `pynep` package.

#### Usage

```sh
python pynep_select_structs.py <sampledata_file> <traindata_file> <nep_model_file>
```

#### Example

```sh
python pynep_select_structs.py dump.xyz train.xyz nep.txt
```

### neptrain_select_structs.py

---

This script samples structures by using the farthest point sampling method implemented in the `neptrain` package.

#### Usage

```sh
python neptrain_select_structs.py <sampledata_file> <traindata_file> <nep_model_file>
```

#### Example

```sh
python neptrain_select_structs.py dump.xyz train.xyz nep.txt
```

### sample_structures.py

---

This script samples structures from an `extxyz` file using either '`uniform`' or '`random`' sampling methods. The sampled structures are then written to the '`sampled_structures.xyz`' file.

`<extxyz_file>`: The path to the input extxyz file containing structures.

`<sampling_method>`: The sampling method to use. Can be '`uniform`' or '`random`'.

`<num_samples>`: The number of samples to extract from the input file.

#### Usage

```sh
python sample_structures.py <extxyz_file> <sampling_method> <num_samples>
```

#### Example

```sh
python sample_structures.py train.xyz uniform 10
```

This command will sample 10 structures uniformly from `train.xyz` and save them to `sampled_structures.xyz`.

### select_max_modev.py

---

Select max force deviation structures from `active.xyz` generated by the command `active` in gpumd.

#### Usage

```sh
python select_max_modev.py <structs_num> <threshold>
```

#### Example

```sh
python select_max_modev.py 100 0.15
```

This command will extract top 100 max force deviation structures in `active.xyz`. `0.15` is the threshold set in the `active` command.




---

## General Usage Guidelines

### Sampling Strategy Selection

Choose sampling method based on your needs:

| Method | When to Use | Pros | Cons |
|--------|-------------|------|------|
| **Uniform** | Initial dataset exploration | Simple, evenly spaced | May miss clusters |
| **Random** | Quick dataset reduction | Simple, unbiased | May cluster samples |
| **PyNEP FPS** | NEP training set creation | Maximizes diversity | Requires trained model |
| **NEPtrain FPS** | Alternative to PyNEP | Also maximizes diversity | Different implementation |
| **Perturb** | Data augmentation | Creates variations | Requires good initial structure |
| **Max force dev** | Active learning | Targets uncertain regions | Requires GPUMD active mode |

### Common Workflows

#### Workflow 1: Create Diverse Training Set

```bash
# 1. Start with large dataset from MD
# (e.g., 10000 structures)

# 2. Initial random sampling
python sample_structures.py md_trajectory.xyz random 2000

# 3. Train initial NEP model
# (Use sampled_structures.xyz)

# 4. Select most diverse structures
gpumdkit.sh -pynep md_trajectory.xyz train.xyz nep_v1.txt

# 5. Train improved model with diverse set
```

#### Workflow 2: Structure Perturbation for Training

```bash
# 1. Have equilibrium structures
# 2. Generate perturbed variants
gpumdkit.sh
# Select: 2) Sample Structures
# Select: 204) Perturb Structure
# Follow prompts...

# 3. Result: 20+ variants of each structure
# 4. Run DFT on perturbed structures
# 5. Use as training data
```

#### Workflow 3: Active Learning Cycle

```bash
# 1. Run GPUMD with active mode
# (Generates active.xyz with force deviations)

# 2. Select structures with high uncertainty
python select_max_modev.py 100 0.15

# 3. Run DFT on selected structures
# 4. Add to training set
# 5. Retrain NEP model
# 6. Repeat cycle
```

#### Workflow 4: Trajectory Downsampling

```bash
# 1. Have long MD trajectory (100k frames)
python sample_structures.py trajectory.xyz uniform 1000

# 2. Or sample specific time intervals
python frame_range.py trajectory.xyz 0 100000 100
# (Every 100th frame)

# 3. Use downsampled trajectory for analysis
```

## Advanced Usage

### Parallel PyNEP Sampling

For large datasets, use parallel version:

```bash
python parallel_pynep_select_structs.py sample.xyz train.xyz nep.txt
```

**Benefits:**
- Faster processing of large files
- Utilizes multiple CPU cores
- Same results as serial version

### Custom Perturbation Strategies

Adjust perturbation parameters based on material:

```python
# For rigid materials (e.g., crystals):
cell_pert_fraction = 0.02  # Small cell deformation
atom_pert_distance = 0.1   # Small atomic displacements

# For soft materials (e.g., molecular systems):
cell_pert_fraction = 0.05  # Larger cell deformation
atom_pert_distance = 0.3   # Larger atomic displacements

# For phase transitions:
cell_pert_fraction = 0.10  # Even larger variations
atom_pert_distance = 0.5   # Significant movements
```

### Combining Sampling Methods

```bash
# 1. Start with random sampling (fast)
python sample_structures.py large_set.xyz random 5000

# 2. Apply FPS on subset (better diversity)
gpumdkit.sh -pynep sampled_structures.xyz train.xyz nep.txt

# 3. Result: Fast and diverse
```

## Sampling Theory

### Farthest Point Sampling (FPS)

FPS maximizes diversity by selecting structures maximally distant in descriptor space:

1. Start with random structure
2. Calculate distances to all other structures
3. Select structure farthest from current set
4. Repeat until desired number selected

**Advantages:**
- Guarantees diversity in descriptor space
- Covers configuration space evenly
- Reduces training set size without losing coverage

**Mathematical formulation:**
```
For each structure i not in set S:
  d(i) = min_{j ∈ S} distance(i, j)
  
Next structure = argmax_i d(i)
```

### Perturbation Theory

Small perturbations explore local configuration space:
- Cell perturbations probe strain response
- Atomic perturbations sample phonon modes
- Combination explores coupled effects

**Perturbation magnitude should:**
- Preserve structural topology
- Stay within DFT convergence range
- Not create unphysical configurations

## Dependencies

### Required
- **Python 3.x**
- **ASE**: Structure manipulation
- **NumPy**: Numerical operations

### Optional
- **PyNEP**: For PyNEP-based sampling
- **NEPtrain**: For NEPtrain-based sampling
- **tqdm**: Progress bars

### Installation

```bash
# Basic
pip install ase numpy

# With PyNEP
pip install pynep

# With progress bars
pip install tqdm
```

## Best Practices

1. **Start diverse**: Begin with diverse initial structures
2. **Validate samples**: Check sampled structures make sense
3. **Iterative refinement**: Use active learning for continuous improvement
4. **Track provenance**: Keep records of sampling parameters
5. **Balance composition**: Ensure all compositions represented

## Troubleshooting

### Issue: "PyNEP not found"

**Problem**: PyNEP package not installed

**Solution**:
```bash
pip install pynep
```

### Issue: "FPS takes too long"

**Problem**: Descriptor calculation slow for large dataset

**Solution**:
1. Downsample first with random/uniform
2. Then apply FPS on smaller set
3. Use parallel version if available

### Issue: "Perturbed structures too distorted"

**Problem**: Perturbation parameters too large

**Solution**:
1. Reduce `cell_pert_fraction` (try 0.01-0.03)
2. Reduce `atom_pert_distance` (try 0.1-0.2 Å)
3. Check structures with visualization

### Issue: "Sampled set not diverse"

**Problem**: Wrong sampling method or insufficient initial diversity

**Solution**:
1. Use FPS instead of random/uniform
2. Increase initial dataset size
3. Include structures from different conditions

### Issue: "Max force deviation selection returns no structures"

**Problem**: Threshold too high or model already good

**Solution**:
1. Lower threshold value
2. Check `active.xyz` has structures with deviations
3. Verify active learning mode was enabled in GPUMD

## Performance Tips

1. **Pre-filter**: Remove obvious outliers before sampling
2. **Batch size**: Process structures in reasonable chunks
3. **Parallel processing**: Use parallel versions for large datasets
4. **Memory management**: Sample in stages for huge datasets

## Integration with Other Tools

### With Analyzers

```bash
# 1. Sample structures
python sample_structures.py large.xyz uniform 1000

# 2. Analyze sampled set
gpumdkit.sh -analyze_comp sampled_structures.xyz
gpumdkit.sh -range sampled_structures.xyz force
```

### With Format Conversion

```bash
# 1. Convert from various formats
gpumdkit.sh -out2xyz ./DFT_calcs/

# 2. Sample from combined set
python sample_structures.py train.xyz uniform 500
```

### With NEP Training

```bash
# 1. Create diverse training set
gpumdkit.sh -pynep candidates.xyz train.xyz nep.txt

# 2. Train NEP
# (Use train.xyz)

# 3. Iterate with active learning
```

## Recommended Practices for Different Scenarios

### For Initial Training Set

```bash
# 1. Collect diverse structures (different compositions, temperatures)
# 2. Random sample to manageable size (~2000)
python sample_structures.py all_structures.xyz random 2000

# 3. Apply FPS for maximum diversity (~500-1000)
gpumdkit.sh -pynep sampled_structures.xyz train.xyz initial_nep.txt
```

### For Active Learning

```bash
# 1. Run MD with active mode in GPUMD
# 2. Select high-uncertainty structures
python select_max_modev.py 50 0.15

# 3. Add to training set after DFT calculations
# 4. Repeat until convergence
```

### For Data Augmentation

```bash
# 1. Have ~100 DFT-relaxed structures
# 2. Generate perturbations
gpumdkit.sh  # Use perturb option

# 3. Run DFT on perturbed structures
# 4. Combine with originals for training
```

## File Management

Recommended organization:

```
sampling/
├── raw_data/
│   └── md_trajectory.xyz         # Original large dataset
├── sampled/
│   ├── uniform_1000.xyz          # Uniformly sampled
│   ├── fps_500.xyz               # FPS selected
│   └── perturbed/                # Perturbed structures
│       ├── struct_001/
│       └── struct_002/
└── training/
    ├── train.xyz                 # Final training set
    └── test.xyz                  # Test set
```

## Contributing

To add new sampling methods:

1. **Follow naming**: `<method>_select_structs.py` or `sample_<method>.py`
2. **Document algorithm**: Explain sampling strategy clearly
3. **Add examples**: Provide usage examples
4. **Benchmark**: Compare with existing methods
5. **Update README**: Add to this documentation

See [CONTRIBUTING.md](../../CONTRIBUTING.md) for detailed guidelines.

---

Thank you for using GPUMDkit! If you have questions about structure sampling, please open an issue on our [GitHub repository](https://github.com/zhyan0603/GPUMDkit/issues) or contact Zihan YAN (yanzihan@westlake.edu.cn).
